import{P as O}from"./PageLoader-WJ_pGOJ4.js";import{_ as I,T as c,c as n,k as v,i as f,b as e,e as b,w as d,v as p,F as h,h as g,x as N,g as P,t as l,o as u,q as D}from"./index-DVMGO384.js";import{p as L,w as _}from"./warehouse-CdibSd_S.js";import{p as k,P as F}from"./production_process_items-BFXdsaUc.js";const A={name:"OutsourcingView",components:{PageLoader:O},created(){this.fetchTodaysDate(),this.fetchPartNumers(),this.fetchPartnerFactories(),this.fetchProductionProcessItems(),this.isLoading=!1},data(){return{blankNewOutsourcing:{actionDate:"",partNumberName:"",partnerFactoryName:"",productionProcessItemName:"",partNumberId:"",partnerFactoryId:"",productionProcessItemId:"",quantity:null,note:""},newOutsourcing:{actionDate:"",partNumberName:"",partnerFactoryName:"",productionProcessItemName:"",partNumberId:"",partnerFactoryId:"",productionProcessItemId:"",quantity:null,note:""},newOutsourcingLists:[],partNumbersList:[],partnerFactories:[],productionProcessItems:[],isLoading:!0,isProcessing:!1}},methods:{async fetchPartNumers(){try{const{data:s,status:t,statusText:i}=await L.getPartNumbers();if(i!=="OK"&&t!==200)throw new Error;const{partNumbers:a}=s;this.partNumbersList=a}catch{c.fire({icon:"error",title:"載入資料錯誤，請稍後在試。"})}},async fetchPartnerFactories(){try{const{data:s,status:t,statusText:i}=await k.getAll(),{partnerFactories:a}=s;if(i!=="OK"&&t!==200)throw new Error;if(s.status!=="success")throw new Error(s.message);this.partnerFactories=a}catch(s){c.fire({icon:"error",title:s||"拿取協力商清單錯誤，請稍後再試。"})}},async fetchProductionProcessItems(){try{const{data:s,status:t,statusText:i}=await F.getAll(),{productionProcessItems:a}=s;if(i!=="OK"&&t!==200)throw new Error;if(s.status!=="success")throw new Error(s.message);this.productionProcessItems=a}catch(s){c.fire({icon:"error",title:s||"拿取製程項目清單錯誤，請稍後再試。"})}},addNewOutsourcingToNewoutsourcingLists(){try{if(!this.verifyDataAfterAddNewClick())throw new Error("日期、品番號、廠商、製程、數量不可空白");if(!this.checkQuantity())throw new Error("數量不足以發包");this.fetchAllItemIdAfterSubmit(),this.newOutsourcingLists.push(this.newOutsourcing),this.newOutsourcing={...this.blankNewOutsourcing}}catch(s){c.fire({icon:"error",title:s||"拿取製程項目清單錯誤，請稍後再試。"})}},verifyDataAfterAddNewClick(){if(this.newOutsourcing.actionDate!==""&&this.newOutsourcing.partNumberName!==""&&this.newOutsourcing.partnerFactoryId!==""&&this.newOutsourcing.productionProcessItemId!==""&&Number(this.newOutsourcing.quantity)>0)return!0},fetchAllItemIdAfterSubmit(){this.partNumbersList.map(s=>{if(s.name===this.newOutsourcing.partNumberName)return this.newOutsourcing.partNumberId=s.id}),this.partnerFactories.map(s=>{if(s.id===this.newOutsourcing.partnerFactoryId)return this.newOutsourcing.partnerFactoryName=s.name}),this.productionProcessItems.map(s=>{if(s.id===this.newOutsourcing.productionProcessItemId)return this.newOutsourcing.productionProcessItemName=s.processName})},checkQuantity(){let s=-1,t=this.partNumbersList.length;for(;s+1!==t;){let i=Math.floor((s+t)/2);if(this.partNumbersList[i].name===this.newOutsourcing.partNumberName)return!(this.partNumbersList[i].quantity<this.newOutsourcing.quantity);this.partNumbersList[i].name<this.newOutsourcing.partNumberName?s=i:t=i}return!1},removeItem(s){try{this.newOutsourcingLists.splice(s,1)}catch{c.fire({icon:"error",title:"錯誤，再試一次。"})}},async handleAfterSubmit(){try{this.isProcessing=!0;const s=new FormData;s.append("outsourcinglist",JSON.stringify(this.newOutsourcingLists));const{data:t,status:i,statusText:a}=await _.Outsourcinglist.create(s);if(i!==200&&a!=="OK")throw new Error;if(t.status!=="success")throw new Error(t.message);this.newOutsourcingLists=[],this.isProcessing=!1,c.fire({icon:"success",text:t.message})}catch(s){this.isProcessing=!1,c.fire({icon:"error",title:s||"拿取製程項目清單錯誤，請稍後再試。"})}},fetchTodaysDate(){let s=new Date().getFullYear().toString(),t="",i="";new Date().getMonth()<9?t=`0${(new Date().getMonth()+1).toString()}`:t=(new Date().getMonth()+1).toString(),new Date().getDate()<10?i=`0${new Date().getDate().toString()}`:i=new Date().getDate().toString();const a=`${s}-${t}-${i}`;this.newOutsourcing.actionDate=a,this.blankNewOutsourcing.actionDate=a}}},x={key:0},S={key:1,class:"view bg-dark mb-3 p-3"},T={class:"d-flex justify-content-between align-items-center"},V={class:"form-row"},C={class:"form-group col-md-2"},E={class:"form-group col-md-2"},q={id:"partNumbers-list"},M=["value"],U={class:"form-group col-md-2"},B=["value"],K={class:"form-group col-md-2"},Q=["value"],j={class:"form-group col-md-2"},Y={class:"form-group col-md-2"},J={class:"mt-5"},X={class:"table table-hover table-striped table-dark"},z={style:{width:"1%"}},G=["onClick"],H={style:{width:"1%"},scope:"row"},R={style:{width:"10%"}},W={style:{width:"15%"}},Z={style:{width:"15%"}},$={style:{width:"15%"}},tt={style:{width:"10%"}},et={key:0,class:"d-flex justify-content-end"},st=["disabled"];function rt(s,t,i,a,o,m){const y=D("PageLoader");return u(),n("div",null,[o.isLoading?(u(),n("div",x,[v(y)])):f("",!0),o.isLoading?f("",!0):(u(),n("div",S,[e("div",T,[t[8]||(t[8]=e("h1",{class:"text-white"},"新增",-1)),e("div",null,[e("button",{onClick:t[0]||(t[0]=b((...r)=>m.addNewOutsourcingToNewoutsourcingLists&&m.addNewOutsourcingToNewoutsourcingLists(...r),["stop","prevent"])),class:"btn btn-outline-warning mr-4"},"加入")])]),e("div",V,[e("div",C,[t[9]||(t[9]=e("label",{class:"add-form-label",for:"inputDate"},"日期",-1)),d(e("input",{"onUpdate:modelValue":t[1]||(t[1]=r=>o.newOutsourcing.actionDate=r),type:"date",class:"form-control",id:"inputDate"},null,512),[[p,o.newOutsourcing.actionDate]])]),e("div",E,[t[10]||(t[10]=e("label",{class:"add-form-label",for:"inputNmae"},"品番號",-1)),d(e("input",{"onUpdate:modelValue":t[2]||(t[2]=r=>o.newOutsourcing.partNumberName=r),list:"partNumbers-list",type:"text",class:"form-control",id:"inputName"},null,512),[[p,o.newOutsourcing.partNumberName]]),e("datalist",q,[(u(!0),n(h,null,g(o.partNumbersList,r=>(u(),n("option",{key:r.id,value:r.name},null,8,M))),128))])]),e("div",U,[t[12]||(t[12]=e("label",{class:"add-form-label",for:"inputNmae"},"廠商",-1)),d(e("select",{"onUpdate:modelValue":t[3]||(t[3]=r=>o.newOutsourcing.partnerFactoryId=r),class:"custom-select",id:"inputPartnerFactoryName"},[t[11]||(t[11]=e("option",{value:"",selected:""},"Choose...",-1)),(u(!0),n(h,null,g(o.partnerFactories,r=>(u(),n("option",{key:r.id,value:r.id},l(r.name),9,B))),128))],512),[[N,o.newOutsourcing.partnerFactoryId]])]),e("div",K,[t[14]||(t[14]=e("label",{class:"add-form-label",for:"inputNmae"},"製程",-1)),d(e("select",{"onUpdate:modelValue":t[4]||(t[4]=r=>o.newOutsourcing.productionProcessItemId=r),class:"custom-select",id:"inputPartnerFactoryName"},[t[13]||(t[13]=e("option",{value:"",selected:""},"Choose...",-1)),(u(!0),n(h,null,g(o.productionProcessItems,r=>(u(),n("option",{key:r.id,value:r.id},l(r.processName),9,Q))),128))],512),[[N,o.newOutsourcing.productionProcessItemId]])]),e("div",j,[t[15]||(t[15]=e("label",{class:"add-form-label",for:"inputQuantity"},"數量",-1)),d(e("input",{"onUpdate:modelValue":t[5]||(t[5]=r=>o.newOutsourcing.quantity=r),type:"number",class:"form-control",id:"inputQuantity"},null,512),[[p,o.newOutsourcing.quantity]])]),e("div",Y,[t[16]||(t[16]=e("label",{class:"add-form-label",for:"inputNote"},"備註",-1)),d(e("input",{"onUpdate:modelValue":t[6]||(t[6]=r=>o.newOutsourcing.note=r),type:"text",class:"form-control",id:"inputNote",placeholder:"可空白..."},null,512),[[p,o.newOutsourcing.note]])])]),e("div",null,[d(e("div",J,[t[18]||(t[18]=e("h1",{class:"text-light text-center"},"清單",-1)),e("table",X,[t[17]||(t[17]=e("thead",null,[e("tr",null,[e("th",{scope:"col"}),e("th",{scope:"col"},"#"),e("th",{scope:"col"},"日期"),e("th",{scope:"col"},"品番"),e("th",{scope:"col"},"廠商"),e("th",{scope:"col"},"製程"),e("th",{scope:"col"},"數量"),e("th",{scope:"col"},"備註")])],-1)),e("tbody",null,[(u(!0),n(h,null,g(o.newOutsourcingLists,(r,w)=>(u(),n("tr",{key:w},[e("td",z,[e("button",{onClick:b(ot=>m.removeItem(w),["stop","prevent"]),class:"btn btn-outline-danger btn-sm rounded-circle"}," X ",8,G)]),e("th",H,l(w+1),1),e("td",R,l(r.actionDate),1),e("td",W,l(r.partNumberName),1),e("td",Z,l(r.partnerFactoryName),1),e("td",$,l(r.productionProcessItemName),1),e("td",tt,l(r.quantity),1),e("td",null,l(r.note),1)]))),128))])])],512),[[P,o.newOutsourcingLists.length>0]])]),o.newOutsourcingLists.length>0?(u(),n("div",et,[e("button",{onClick:t[7]||(t[7]=b((...r)=>m.handleAfterSubmit&&m.handleAfterSubmit(...r),["stop","prevent"])),type:"submit",class:"btn btn-primary",disabled:o.isProcessing},l(o.isProcessing?"處理中...":"送出"),9,st)])):f("",!0)]))])}const lt=I(A,[["render",rt],["__scopeId","data-v-5a19089a"]]);export{lt as default};
